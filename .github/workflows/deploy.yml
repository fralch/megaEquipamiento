name: Auto Deploy Laravel + React (Robusto)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}  
        port: ${{ secrets.SSH_PORT || 22 }}
        script: |
          set -e  # Detener si hay errores
          
          # Ir al directorio del proyecto
          cd ${{ secrets.PROJECT_PATH }}
          
          echo "ğŸš€ Iniciando deploy..."
          echo "ğŸ“ Directorio actual: $(pwd)"
          
          # Verificar que estamos en una rama limpia
          if [ -n "$(git status --porcelain)" ]; then
            echo "âš ï¸ Hay cambios sin commitear, haciendo stash..."
            git stash
          fi
          
          # Hacer git pull
          echo "ğŸ”„ Haciendo git pull..."
          git pull 
          
          # Verificar si composer.json cambiÃ³
          if git diff --name-only HEAD~1 HEAD | grep -q "composer.json\|composer.lock"; then
            echo "ğŸ“¦ Instalando dependencias de Composer..."
            composer install --no-dev --optimize-autoloader --no-interaction
          fi
          
          # Verificar si package.json cambiÃ³
          if git diff --name-only HEAD~1 HEAD | grep -q "package.json\|package-lock.json"; then
            echo "ğŸ“¦ Instalando dependencias de npm..."
            npm install
          fi
          
          
          # Ejecutar migraciones (solo si hay migraciones pendientes)
          echo "ğŸ—„ï¸ Verificando migraciones..."
          if php artisan migrate:status | grep -q "Ran?.*No"; then
            echo "ğŸ—„ï¸ Ejecutando migraciones..."
            php artisan migrate --force
          else
            echo "âœ… No hay migraciones pendientes"
          fi
          
          # Construir assets con Vite
          echo "ğŸ—ï¸ Construyendo assets con Vite..."
          npm run build
          
          # Limpiar y optimizar cache
          echo "ğŸ§¹ Limpiando cache..."
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          
          echo "âš¡ Optimizando para producciÃ³n..."
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          
          # Establecer permisos correctos
          echo "ğŸ” Estableciendo permisos..."
          chmod -R 775 storage bootstrap/cache
          
      
          
          echo "âœ… Deploy completado exitosamente!"
          echo "ğŸŒ Tu aplicaciÃ³n estÃ¡ lista en: https://${{ secrets.SSH_HOST }}"